{% extends "base.html" %}
{% block title %}Editar Perfil - SELOEDU{% endblock %}
{% block content %}
<h1>Editar Perfil</h1>

<form method="post" action="{{ url_for('users.profile_edit') }}" enctype="multipart/form-data">
  {{ form.hidden_tag() if form }}

  <div style="display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap;">
    <div style="display:flex; flex-direction:column; align-items:center; gap:10px; min-width:220px;">
      <div id="photo-box"
           style="width:200px;height:200px;border-radius:50%;overflow:hidden;background:#ddd;display:flex;align-items:center;justify-content:center;cursor:pointer;">
        {% if profile and profile.foto_thumb %}
          <img id="current-photo" src="{{ url_for('static', filename='uploads/' ~ profile.foto_thumb) }}"
               alt="Foto atual" style="width:200px;height:200px;object-fit:cover;display:block;">
        {% elif profile and profile.foto %}
          <img id="current-photo" src="{{ url_for('static', filename='uploads/' ~ profile.foto) }}"
               alt="Foto atual" style="width:200px;height:200px;object-fit:cover;display:block;">
        {% else %}
          <span id="initials" style="font-weight:700;font-size:48px;color:#fff;">
            {{ (current_user.nome.split()[0][0] ~ current_user.nome.split()[-1][0]).upper() if current_user and current_user.nome and current_user.nome.split()|length>1
               else (current_user.nome[:2].upper() if current_user and current_user.nome else '?') }}
          </span>
        {% endif %}
      </div>

      <label for="foto" style="display:inline-block;padding:8px 12px;background:#eee;border:1px solid #ccc;border-radius:6px;cursor:pointer;">
        Escolher foto
      </label>
      {{ form.foto(id='foto', style='display:none;') if form }}
    </div>

    <div style="flex:1 1 420px; min-width:260px;">
      <div style="margin-bottom:10px;">
        <label>Cargo</label><br>
        {{ form.cargo(style="width:40%") }}
      </div>
      <div style="margin-bottom:10px;">
        <label>Instituição</label><br>
        {{ form.instituicao(style="width:40%") }}
      </div>
      <div style="margin-bottom:10px;">
        <label>Telefone</label><br>
        {{ form.telefone(style="width:40%") }}
      </div>
      <div style="margin-top:6px;">
        <label>Bio</label><br>
        {{ form.bio(rows="6", style="width:70%") }}
      </div>

      <div style="margin-top:14px;">
        {{ form.submit(class="btn btn-primary") }}
        <a class="btn btn-outline" href="{{ url_for('users.profile') }}">Cancelar</a>
      </div>
    </div>
  </div>
</form>

<script>
  const fotoInput = document.getElementById('foto');
  const photoBox = document.getElementById('photo-box');
  const initialsSpan = document.getElementById('initials');

  photoBox && photoBox.addEventListener('click', () => fotoInput && fotoInput.click());
  fotoInput && fotoInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      alert('Selecione uma imagem.');
      fotoInput.value = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = (ev) => {
      if (initialsSpan) initialsSpan.style.display = 'none';
      let img = document.getElementById('current-photo');
      if (!img) {
        img = document.createElement('img');
        img.id = 'current-photo';
        img.alt = 'Preview';
        img.style.width = '200px';
        img.style.height = '200px';
        img.style.objectFit = 'cover';
        photoBox.innerHTML = '';
        photoBox.appendChild(img);
      }
      img.src = ev.target.result;
      img.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });
</script>
{% endblock %}

